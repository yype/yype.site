<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="N1CTF2020 n1vault, thoughts &amp; solutions" /><meta property="og:locale" content="en_US" /><meta name="description" content="Intro" /><meta property="og:description" content="Intro" /><link rel="canonical" href="http://localhost:4000/2020/10/23/n1vault" /><meta property="og:url" content="http://localhost:4000/2020/10/23/n1vault" /><meta property="og:site_name" content="yype.site" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-23T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="N1CTF2020 n1vault, thoughts &amp; solutions" /><meta name="twitter:site" content="@_yype" /> <script type="application/ld+json"> {"headline":"N1CTF2020 n1vault, thoughts &amp; solutions","dateModified":"2020-10-23T00:00:00+08:00","datePublished":"2020-10-23T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/10/23/n1vault"},"description":"Intro","url":"http://localhost:4000/2020/10/23/n1vault","@type":"BlogPosting","@context":"https://schema.org"}</script><title> N1CTF2020 n1vault, thoughts &amp; solutions - yype.site</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="yype.site" href="/atom.xml"><link rel="alternate" type="application/json" title="yype.site" href="http://localhost:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline;word-break:break-word}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0;word-break:break-word;display:inline}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0;opacity:0.2}>ol,>ul,>dl{padding-left:2rem}>ol li+li,>ul li+li,>dl li+li{margin-top:0.3rem}li{word-break:break-word}li>ol,li>ul,li>dl{padding-left:2rem}li>p{margin:1rem 0 0.8rem}li>a{word-break:normal}ul>li{word-break:break-all}ul,ol{list-style-position:inside}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}</style></head><body><main role="main"><header role="banner"> <!--<h1 class="logo">yype.site</h1>--><nav role="navigation"><ul><li><a href="/" >yype.site</a></li><li><a href="/about" >About</a></li><li><a href="/search" >Search</a></li><li><a href="/atom.xml" >Rss</a></li></ul></nav></header><section class="post"><h2>N1CTF2020 n1vault, thoughts & solutions</h2><link href="/assets/css/syntax.css" rel="stylesheet" ><h2 id="intro">Intro</h2><p>I designed the RE challenge <em>n1vault</em> in the recent CTF <a href="https://ctftime.org/event/1099" target="_blank">N1CTF2020</a>, in this post I will talk about details about this chal and offer some possible solutions.</p><p>The core part of this challenge is to craft a file’s CRC to an arbitrary value(zero) by modifying some specified bytes of the same bit size as the CRC value.</p><p>As for the binary <code class="highlighter-rouge">n1vault</code>, it uses SHA256 to digest all the bytes inside the file(<code class="highlighter-rouge">credencial.png</code>) except for the even bytes in the last 25 bytes(some twists were added to the <em>sha256_update</em> function, paving the way for the backdoor), once the file’s CRC has been faked to 0, a secret logic(backdoor) will be triggered by an exception <em>FPE_INTDIV</em>, since the verification inside function <code class="highlighter-rouge">main</code> has an unnecessary comparison <code class="highlighter-rouge">4764888639493207598 / (crc32_result | crc64_result) == 1</code>, which will trigger an <em>FPE_INTDIV</em> when both crc32_result and crc64_result are zero, and will be evaluated to <em>true</em> when given the original file <code class="highlighter-rouge">credential.png</code>. Players’ job is to to craft an input to trigger the backdoor, send the crafted bytes to the judging bot and receive the flag.</p><h2 id="solution">Solution</h2><p>The reverse engineering part of the binary program is quite easy, some junks with fixed patterns are inserted into the main logic, which can be bypassed by simple searching &amp; replacing. After that the program logic is really straightforward, we only have to solve the math problem left.</p><p>CRC has a property that the final result can be viewed as the linear combination of the influence of each bit in the message and an initial bias, based on $GF(2)$, which can be described as: \(f(x)=f(0) + \sum_{i=0}^{CRC\_SIZE-1} x_i \cdot \mbox{influence}(i),\) where $f(0)$ is the initial bias, specifically for this challenge, is the CRC of the credential with all the even bytes in the last 25 bytes set to zero. Given this property, if we have enough $x_i$ to control, we can easily construct a matrix and solve each $x_i$ using gauss elimination. The twist here is that we have to ensure both $f(x)=CRC32(credential)$ and $g(x)=CRC64(credential)$ are equal to zero. Actually if we let $h(x)=(f(x) &lt; &lt; 64)+g(x)$ and focus our attention on making $h(x)=0$, it has the same effect as making both $f(x)$ and $g(x)$ zero.</p><p>I write a tool based on this interesting property of CRC, allowing us to arbitrarily craft a file’s CRC by specifying certain bits available for modification. It can output all the available solutions and allows for fewer available bits than the bit size of the CRC result. You can check the tool here:</p><blockquote><p><a href="https://github.com/yype/crcollider" target="_blank">https://github.com/yype/crcollider</a></p></blockquote><p>Using this tool we can easily solve the problem using the following Python code:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">crcollider</span> <span class="kn">import</span> <span class="n">collcrc</span>
<span class="kn">from</span> <span class="nn">crc_funcs</span> <span class="kn">import</span> <span class="n">crc64</span><span class="p">,</span> <span class="n">crc32</span>

<span class="k">def</span> <span class="nf">crc96</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">crc32</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">+</span> <span class="n">crc64</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">solve_chal</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'credential.png'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">org_img</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">rg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">org_img</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">available_bits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
        <span class="c1"># even bytes in the last 25 bytes
</span>        <span class="n">available_bits</span> <span class="o">+=</span> <span class="n">rg</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">rg</span><span class="p">)</span><span class="o">-</span><span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="o">-</span><span class="mi">16</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">rg</span><span class="p">)</span><span class="o">-</span><span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>

    <span class="n">sol_num</span><span class="p">,</span> <span class="n">sols</span> <span class="o">=</span> <span class="n">collcrc</span><span class="p">(</span><span class="n">crc96</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="n">org_img</span><span class="p">,</span> <span class="n">available_bits</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span>
    
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">'{sol_num} solution(s) found'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">each</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sols</span><span class="p">):</span>
        <span class="n">file_out</span> <span class="o">=</span> <span class="n">f</span><span class="s">'credential_sol{i}.png'</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">'Outputting sol{i} to {file_out}...'</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_out</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">solve_chal</span><span class="p">()</span>

</code></pre></div></div><p>There are totally 4 solutions available for this challenge. One of them contains only visible characters, which is <code class="highlighter-rouge">n1vaultadmin</code>(intentionally crafted), while others are not. It might be better if I put some constraints to ensure that only one solution is available though.</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>solution&gt; python3 .\main.py
4 solution(s) found
Outputting sol0 to credential_sol0.png...
Outputting sol1 to credential_sol1.png...
Outputting sol2 to credential_sol2.png...
Outputting sol3 to credential_sol3.png...
</code></pre></div></div><p>You can also check the awesome write-up from team <em>Super Guesser</em> who got the first blood of this challenge here: <a href="https://gist.github.com/jhs7jhs/cb5fedc1ffb6138b73420cb8567357bb#n1vault" target="_blank">https://gist.github.com/jhs7jhs/cb5fedc1ffb6138b73420cb8567357bb#n1vault</a>.</p><p>The source code of this challenge and a duplicate of this post are uploaded to GitHub, check them out at: <a href="https://github.com/Nu1LCTF/n1ctf-2020/tree/main/RE/n1vault" target="_blank">https://github.com/Nu1LCTF/n1ctf-2020/tree/main/RE/n1vault</a>.</p><span class="meta"><time datetime="2020-10-23T00:00:00+08:00">October 23, 2020</time> &middot; <a href="/tag/CTF">CTF</a>, <a href="/tag/Reverse Engineering">Reverse Engineering</a>, <a href="/tag/N1CTF2020">N1CTF2020</a></span></section></main></body><script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']], processEscapes: true } }); </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ CommonHTML: { scale: 90 }, "HTML-CSS": { scale: 90 }, NativeMML: { scale: 90 }, SVG: { scale: 90 }, PreviewHTML: { scale: 90 } }); </script></html>
