<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="D^3CTF2019 Ancient Game V2, Thoughts &amp; Solutions" /><meta property="og:locale" content="en_US" /><meta name="description" content="Intro" /><meta property="og:description" content="Intro" /><link rel="canonical" href="http://localhost:4000/2020/02/20/ancient-game-v2" /><meta property="og:url" content="http://localhost:4000/2020/02/20/ancient-game-v2" /><meta property="og:site_name" content="yype.site" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-02-20T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="D^3CTF2019 Ancient Game V2, Thoughts &amp; Solutions" /><meta name="twitter:site" content="@_yype" /> <script type="application/ld+json"> {"headline":"D^3CTF2019 Ancient Game V2, Thoughts &amp; Solutions","dateModified":"2020-02-20T00:00:00+08:00","datePublished":"2020-02-20T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/02/20/ancient-game-v2"},"description":"Intro","url":"http://localhost:4000/2020/02/20/ancient-game-v2","@type":"BlogPosting","@context":"https://schema.org"}</script><title> D^3CTF2019 Ancient Game V2, Thoughts &amp; Solutions - yype.site</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="yype.site" href="/atom.xml"><link rel="alternate" type="application/json" title="yype.site" href="http://localhost:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><link href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/copy-tex.css" rel="stylesheet" type="text/css"> <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/copy-tex.min.js" integrity="sha384-XhWAe6BtVcvEdS3FFKT7Mcft4HJjPqMQvi5V4YhzH9Qxw497jC13TupOEvjoIPy7" crossorigin="anonymous"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"> <script type="module"> import renderMathInElement from "https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.mjs"; renderMathInElement(document.body,{delimiters: [ {left: "$$", right: "$$", display: true}, {left: "\\[", right: "\\]", display: true}, {left: "$", right: "$", display: false}, {left: "\\(", right: "\\)", display: false} ]}); </script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline;word-break:break-word}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0;word-break:break-word;display:inline}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:90%}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0;opacity:0.2}>ol,>ul,>dl{padding-left:2rem}>ol li+li,>ul li+li,>dl li+li{margin-top:0.3rem}li{word-break:break-word}li>ol,li>ul,li>dl{padding-left:2rem}li>p{margin:1rem 0 0.8rem}li>a{word-break:normal}ul>li{word-break:break-all}ul,ol{list-style-position:inside}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}.katex{font-size:1.1em}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{margin:0.5rem 0;border-left:5px solid #ececec;padding-left:1rem;color:#363636}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}</style></head><body><main role="main"><header role="banner"> <!--<h1 class="logo">yype.site</h1>--><nav role="navigation"><ul><li><a href="/" >yype.site</a></li><li><a href="/about" >About</a></li><li><a href="/search" >Search</a></li><li><a href="/atom.xml" >Rss</a></li></ul></nav></header><section class="post"><h2>D^3CTF2019 Ancient Game V2, Thoughts & Solutions</h2><link href="/assets/css/syntax.css" rel="stylesheet" ><h2 id="intro">Intro</h2><p>I designed the RE challenge <em>Ancient Game V2</em> in D^3CTF2019. This post is about some related stuff along with the chal’s solution.</p><h2 id="challenge">Challenge</h2><p>This challenge uses a virtual architecture similar to OISC to implement a classic Sudoku verification. There are basically just 4 types of instructions: input, output, jcc and NAND, which can also be seen as an OISC with two I/O interrupts introduced. All logical operations are implemented through NAND gates.</p><p>Operations like XOR / AND / OR are all implemented by combinations of NAND gates, for example:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xor x,y =&gt;
xor_tmp[0] = y NAND y
xor_tmp[1] = x NAND xor_tmp[0]
xor_tmp[2] = x NAND x
xor_tmp[3] = y NAND xor_tmp[2]
x = xor_tmp[1] NAND xor_tmp[3]
</code></pre></div></div><p>Which is based on the fact that:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Q = A XOR B = [ B NAND ( A NAND A ) ] NAND [ A NAND ( B NAND B ) ]
</code></pre></div></div><p>An excerpt of the Sudoku Verifier code in my <em>self-defined assembly</em>:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>welcome = mkstr("**************************\n**  Welcome To D^3CTF   **\n**   Ancient Game V2    **\n**************************\n\nInput Flag:")
wrong = mkstr("\nSorry, please try again.\n")
correct = mkstr("\nCorrect.\n")

flag = new(50)
// distract = new(1000)
grid = new(81)


// initialize the puzzle
set(grid[0],9)
set(grid[5],8)
set(grid[9],1)
set(grid[10],3)
set(grid[14],9)
set(grid[16],7)
...
set(grid[71],6)
set(grid[75],9)
set(grid[80],1)

__code_start__

// print the welcome message
print(welcome)

// get input
input(flag[0])
input(flag[1])
input(flag[2])
input(flag[3])
input(flag[4])
input(flag[5])
...
input(flag[46])
input(flag[47])
input(flag[48])
input(flag[49])

// transfer chars in the flag into the grids

long_transfer(flag[0],grid[1])
long_transfer(flag[1],grid[2])
...
long_transfer(flag[47],grid[77])
long_transfer(flag[48],grid[78])
long_transfer(flag[49],grid[79])

// xor with xor_table, which is introduced 
//   for generating different flags to different teams

grid[1] = grid[1] ^ xor_table[0]
grid[2] = grid[2] ^ xor_table[1]
grid[3] = grid[3] ^ xor_table[2]
grid[4] = grid[4] ^ xor_table[3]
grid[6] = grid[6] ^ xor_table[4]
grid[7] = grid[7] ^ xor_table[5]
...
grid[77] = grid[77] ^ xor_table[47]
grid[78] = grid[78] ^ xor_table[48]
grid[79] = grid[79] ^ xor_table[49]

// verify the sudoku game

// rows
jmp _label_wrong if grid[4] == grid[5]
jmp _label_wrong if grid[4] == grid[6]
jmp _label_wrong if grid[4] == grid[7]
...
jmp _label_wrong if grid[3] == grid[7]
jmp _label_wrong if grid[3] == grid[8]

// columns
jmp _label_wrong if grid[0] == grid[9]
jmp _label_wrong if grid[0] == grid[18]
jmp _label_wrong if grid[0] == grid[27]
...
jmp _label_wrong if grid[62] == grid[80]
jmp _label_wrong if grid[71] == grid[80]

// subgrids
jmp _label_wrong if grid[0] == grid[1]
jmp _label_wrong if grid[0] == grid[2]
jmp _label_wrong if grid[0] == grid[9]
jmp _label_wrong if grid[0] == grid[10]
...
jmp _label_wrong if grid[78] == grid[79]
jmp _label_wrong if grid[78] == grid[80]
jmp _label_wrong if grid[79] == grid[80]

// check range

jmp _label_wrong if outofnumbers(grid[1])
jmp _label_wrong if outofnumbers(grid[2])
jmp _label_wrong if outofnumbers(grid[3])
jmp _label_wrong if outofnumbers(grid[4])
...
jmp _label_wrong if outofnumbers(grid[76])
jmp _label_wrong if outofnumbers(grid[77])
jmp _label_wrong if outofnumbers(grid[78])
jmp _label_wrong if outofnumbers(grid[79])

_label_correct:
print(correct)
return

_label_wrong:
print(wrong)
return
</code></pre></div></div><p>I wrote an assembler for this assembly, which was used to generate the final challenge that the players got. The assembler wasn’t open-sourced since it’s ugly.</p><p>During the competition, due to the negligence of myself, the implementation of the <code class="highlighter-rouge">outofnumbers (var)</code> function was incorrectly written as <code class="highlighter-rouge">return var not in range (10)</code>, resulting in multiple solutions. Since the target Sudoku should only be filled with 1 ~ 9, the correct implementation should be <code class="highlighter-rouge">return var not in range (1, 10)</code>. This was my fault, and I had to update the challenge with a fixed one during the competition.</p><p><strong>Sudoku Map</strong></p><p><img src="https://camo.githubusercontent.com/9e3d18179573b913f906045e17194334fe646330e821fc86032756fece3958a2/68747470733a2f2f692e696d6775722e636f6d2f50727a6d7945752e706e67" alt="" /></p><p><strong>Solution</strong></p><p>To solve this challenge, there is no need to simplify all the logical operations. Since there is no complicated loop in the chal’s actual control flow, we can find conditions that prevent the control flow from jumping to the part which outputs “Sorry” through simple control flow tracing and symbolic analysis. Finally, we can use an SMT solver to solve the constraints that we get through the previous analysis(That’s how ThinerDAS solved this challenge).</p><p>Flag: d3ctf{g5lk9t28zz47y3l6m2kosbajd2vk9e2dwghxgfktcki}</p><blockquote><p>Referenceable solution script: <a href="https://github.com/0h2o/D3CTF_Rev/blob/master/AncientGameV2/sol.py">sol.py</a> by <a href="https://github.com/byaidu">Byaidu</a></p></blockquote><p>The source code of this challenge(not fully open-sourced) and a duplicate of this post are uploaded to GitHub, check them out at: <a href="https://github.com/yype/D3CTF_Rev/tree/master/AncientGameV2" target="_blank">https://github.com/yype/D3CTF_Rev/tree/master/AncientGameV2</a>.</p><h2 id="more">More..</h2><p>I’ve always found OISC quite interesting to me. This challenge was just a demo of one of my ideas, maybe I will do some extra work related to OISC in the upcoming future.</p><span class="meta"><time datetime="2020-02-20T00:00:00+08:00">February 20, 2020</time> &middot; <a href="/tag/CTF">CTF</a>, <a href="/tag/Reverse Engineering">Reverse Engineering</a>, <a href="/tag/D^3CTF2019">D^3CTF2019</a>, <a href="/tag/OISC">OISC</a></span></section></main></body>
